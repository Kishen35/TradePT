<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PocketPT ‚Äî Choose Your Trading Style</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,600&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  /* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0d0e11;
    --surface: #14161a;
    --surface-2: #1c1f25;
    --border: rgba(255,255,255,.07);
    --red: #e63946;
    --teal: #2ec4b6;
    --text: #f0f0f0;
    --muted: #6b7280;
    --font: 'IBM Plex Sans', sans-serif;
    --mono: 'IBM Plex Mono', monospace;
  }
  html { scroll-behavior: smooth; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    font-size: 15px;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
  nav {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 32px;
    height: 56px;
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 100;
    background: rgba(13,14,17,.92);
    backdrop-filter: blur(12px);
  }
  .nav-brand { font-weight: 700; font-size: 17px; letter-spacing: -.3px; }
  .brand-red { color: var(--red); }
  .brand-dot { display: inline-block; width: 5px; height: 5px; background: var(--red); border-radius: 50%; margin-left: 2px; vertical-align: middle; }
  .nav-right { font-size: 12px; color: var(--muted); font-family: var(--mono); }

  /* ‚îÄ‚îÄ Page layout ‚îÄ‚îÄ */
  .page { max-width: 1100px; margin: 0 auto; padding: 48px 24px 80px; }
  .page-tag {
    display: inline-flex; align-items: center; gap: 7px;
    font-family: var(--mono); font-size: 11px; color: var(--muted);
    letter-spacing: .08em; text-transform: uppercase;
    border: 1px solid var(--border); border-radius: 20px;
    padding: 4px 12px; margin-bottom: 20px;
  }
  .live-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--red);
    animation: pulse 1.8s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(.7)} }
  .page-h1 { font-size: clamp(28px,5vw,46px); font-weight: 700; letter-spacing: -.5px; line-height: 1.15; margin-bottom: 14px; }
  .page-h1 em { color: var(--red); font-style: italic; }
  .page-sub { color: var(--muted); max-width: 560px; font-size: 15px; margin-bottom: 40px; }

  /* ‚îÄ‚îÄ VS Layout ‚îÄ‚îÄ */
  .vs-layout {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 0 24px;
    align-items: start;
  }
  @media (max-width: 700px) {
    .vs-layout { grid-template-columns: 1fr; gap: 16px 0; }
    .vs-divider { flex-direction: row; gap: 0; padding: 0; }
    .vs-line, .vs-line-bottom { flex: 1; height: 1px; width: auto; }
    .vs-badge { margin: 0 16px; }
  }

  /* ‚îÄ‚îÄ Strategy Card ‚îÄ‚îÄ */
  .strategy-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    cursor: pointer;
    transition: transform .2s, box-shadow .2s, border-color .2s;
  }
  .strategy-card:hover { transform: translateY(-3px); box-shadow: 0 12px 40px rgba(0,0,0,.3); }
  .strategy-card.selected-left { border-color: var(--red); box-shadow: 0 0 0 2px rgba(230,57,70,.25); }
  .strategy-card.selected-right { border-color: var(--teal); box-shadow: 0 0 0 2px rgba(46,196,182,.25); }
  .strategy-card.unselected { opacity: .45; filter: grayscale(.4); }

  /* Card hero */
  .card-hero {
    padding: 28px 24px 22px;
    display: flex; flex-direction: column; align-items: flex-start; gap: 6px;
    position: relative;
  }
  .card-hero-left { background: linear-gradient(135deg, #1a0a0c 0%, #1e1010 100%); }
  .card-hero-right { background: linear-gradient(135deg, #071415 0%, #0b1c1b 100%); }
  .card-badge {
    font-family: var(--mono); font-size: 10px; font-weight: 500;
    letter-spacing: .1em; text-transform: uppercase;
    padding: 3px 9px; border-radius: 4px; margin-bottom: 4px;
  }
  .badge-left { background: rgba(230,57,70,.15); color: var(--red); border: 1px solid rgba(230,57,70,.25); }
  .badge-right { background: rgba(46,196,182,.12); color: var(--teal); border: 1px solid rgba(46,196,182,.2); }
  .card-icon { font-size: 36px; line-height: 1; margin-bottom: 4px; }
  .card-title { font-size: 22px; font-weight: 700; letter-spacing: -.3px; }
  .card-subtitle { font-size: 12px; color: var(--muted); font-family: var(--mono); }

  /* Card body */
  .card-body { padding: 22px 24px 24px; }
  .card-desc { font-size: 14px; color: #b0b5bf; margin-bottom: 20px; line-height: 1.65; }
  .card-desc em { color: var(--text); font-style: italic; }

  /* Trait list */
  .trait-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
  .trait-row { display: flex; gap: 10px; align-items: flex-start; }
  .trait-icon { font-size: 15px; flex-shrink: 0; margin-top: 1px; }
  .trait-text { font-size: 13px; color: #9ca3af; }
  .trait-text strong { color: var(--text); font-weight: 600; }

  /* Metrics strip */
  .metrics-strip {
    display: grid; grid-template-columns: repeat(3,1fr);
    gap: 1px; background: var(--border);
    border: 1px solid var(--border); border-radius: 10px;
    overflow: hidden; margin-bottom: 16px;
  }
  .metric { background: var(--surface-2); padding: 12px 10px; text-align: center; }
  .metric-val { font-family: var(--mono); font-weight: 500; font-size: 14px; }
  .metric-val.red { color: var(--red); }
  .metric-val.teal { color: var(--teal); }
  .metric-label { font-size: 10px; color: var(--muted); margin-top: 3px; letter-spacing: .04em; }

  /* Psych tags */
  .psych-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
  .psych-tag {
    font-size: 11px; font-family: var(--mono);
    padding: 3px 9px; border-radius: 4px;
    background: rgba(255,255,255,.04); border: 1px solid var(--border); color: var(--muted);
  }

  /* Select button */
  .select-btn {
    width: 100%; padding: 12px 0; border-radius: 9px; border: none; cursor: pointer;
    font-family: var(--font); font-weight: 600; font-size: 14px; letter-spacing: .02em;
    transition: opacity .2s, transform .15s;
  }
  .select-btn:hover:not(:disabled) { opacity: .88; transform: translateY(-1px); }
  .select-btn.chosen { opacity: .7; cursor: default; }
  .select-btn-left { background: var(--red); color: #fff; }
  .select-btn-right { background: var(--teal); color: #0d1412; }

  /* ‚îÄ‚îÄ VS Divider ‚îÄ‚îÄ */
  .vs-divider {
    display: flex; flex-direction: column; align-items: center;
    gap: 0; padding-top: 80px;
  }
  .vs-line { width: 1px; height: 80px; background: var(--border); }
  .vs-line-bottom { width: 1px; height: 80px; background: var(--border); }
  .vs-badge {
    font-family: var(--mono); font-weight: 500; font-size: 11px;
    color: var(--muted); background: var(--surface-2);
    border: 1px solid var(--border); border-radius: 20px;
    padding: 5px 10px; letter-spacing: .08em;
  }

  /* ‚îÄ‚îÄ Result Panel ‚îÄ‚îÄ */
  .result-panel {
    margin-top: 40px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    display: none;
    animation: slideUp .35s ease;
  }
  .result-panel.visible { display: block; }
  @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
  .result-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface-2);
    flex-wrap: wrap; gap: 12px;
  }
  .result-header-left { display: flex; align-items: center; gap: 14px; }
  .result-icon { font-size: 32px; }
  .result-title { font-weight: 600; font-size: 16px; }
  .result-desc { font-size: 13px; color: var(--muted); margin-top: 2px; }
  .ai-badge-sm {
    font-size: 11px; font-family: var(--mono);
    padding: 4px 10px; border-radius: 6px;
    background: rgba(230,57,70,.1); color: var(--red);
    border: 1px solid rgba(230,57,70,.2);
  }
  .result-body { padding: 24px; }
  .insight-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px; margin-bottom: 20px;
  }
  .insight-card {
    background: var(--surface-2); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 16px;
  }
  .insight-label { font-size: 10px; color: var(--muted); font-family: var(--mono); letter-spacing: .06em; text-transform: uppercase; margin-bottom: 5px; }
  .insight-val { font-size: 14px; font-weight: 600; }
  .ai-insight-text-result {
    font-size: 14px; color: #9ca3af; line-height: 1.75;
    background: var(--surface-2); border-left: 3px solid var(--red);
    padding: 14px 16px; border-radius: 0 8px 8px 0;
    margin-bottom: 20px;
  }
  .ai-insight-text-result.teal { border-left-color: var(--teal); }
  .ai-insight-text-result strong { color: var(--text); }
  .ai-insight-text-result em { color: var(--text); font-style: italic; }
  .result-footer { display: flex; gap: 12px; flex-wrap: wrap; }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn-primary {
    padding: 12px 24px; border-radius: 9px; border: none; cursor: pointer;
    background: var(--red); color: #fff;
    font-family: var(--font); font-weight: 600; font-size: 14px;
    transition: opacity .2s;
  }
  .btn-primary.teal { background: var(--teal); color: #0d1412; }
  .btn-primary:hover { opacity: .85; }
  .btn-ghost {
    padding: 12px 20px; border-radius: 9px; cursor: pointer;
    background: transparent; color: var(--muted);
    border: 1px solid var(--border);
    font-family: var(--font); font-size: 14px;
    transition: color .2s, border-color .2s;
  }
  .btn-ghost:hover { color: var(--text); border-color: rgba(255,255,255,.2); }

  /* ‚îÄ‚îÄ XP Toast ‚îÄ‚îÄ */
  .xp-toast {
    position: fixed; bottom: 28px; right: 28px;
    background: var(--surface-2); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 18px;
    display: flex; gap: 10px; align-items: center;
    transform: translateY(80px); opacity: 0;
    transition: transform .3s, opacity .3s;
    z-index: 1000;
  }
  .xp-toast.show { transform: translateY(0); opacity: 1; }
  .xp-amount { font-family: var(--mono); font-weight: 600; font-size: 15px; color: var(--red); }
  .xp-reason { font-size: 13px; color: var(--muted); }

  /* ‚îÄ‚îÄ Skeleton / Loading ‚îÄ‚îÄ */
  .skeleton {
    background: linear-gradient(90deg, var(--surface-2) 25%, rgba(255,255,255,.04) 50%, var(--surface-2) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 6px;
  }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  .skel-title { height: 22px; width: 70%; margin-bottom: 8px; }
  .skel-sub { height: 13px; width: 50%; margin-bottom: 16px; }
  .skel-line { height: 13px; width: 100%; margin-bottom: 6px; }
  .skel-line.short { width: 80%; }
  .skel-line.shorter { width: 60%; }
  .skel-metric { height: 36px; border-radius: 8px; }
  .skel-tag { height: 22px; width: 80px; border-radius: 4px; }
  .skel-btn { height: 44px; border-radius: 9px; margin-top: 4px; }
  .skel-icon { height: 40px; width: 40px; border-radius: 8px; margin-bottom: 8px; }
  .loading-indicator {
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; font-family: var(--mono); color: var(--muted);
    padding: 8px 0;
  }
  .loading-dots span {
    display: inline-block; width: 4px; height: 4px; border-radius: 50%;
    background: var(--muted); margin: 0 2px;
    animation: blink 1.2s infinite;
  }
  .loading-dots span:nth-child(2) { animation-delay: .2s; }
  .loading-dots span:nth-child(3) { animation-delay: .4s; }
  @keyframes blink { 0%,80%,100%{opacity:.2} 40%{opacity:1} }

  /* ‚îÄ‚îÄ Error state ‚îÄ‚îÄ */
  .error-msg {
    background: rgba(230,57,70,.08); border: 1px solid rgba(230,57,70,.2);
    border-radius: 10px; padding: 14px 16px;
    font-size: 13px; color: #e67e87;
  }
  .error-msg strong { color: var(--red); }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-brand">Pocket<span class="brand-red">PT</span><span class="brand-dot"></span></div>
  <div class="nav-right">Onboarding</div>
</nav>

<div class="page">

  <div class="page-tag">
    <div class="live-dot"></div>
    Style Profiling
  </div>
  <h1 class="page-h1">Which strategy feels<br>like <em>you</em>?</h1>
  <p class="page-sub">Choose the trading style that best matches how you think and make decisions. This personalises your entire curriculum ‚Äî lessons, scenarios, and AI tutor feedback.</p>

  <!-- VS Cards -->
  <div class="vs-layout">
    <div class="strategy-card" id="card-left" onclick="selectStrategy('left')">
      <div class="card-hero card-hero-left">
        <div class="card-badge badge-left">Strategy A</div>
        <div id="hero-left-content">
          <!-- skeleton -->
          <div class="skel-icon skeleton"></div>
          <div class="skel-title skeleton"></div>
          <div class="skel-sub skeleton"></div>
        </div>
      </div>
      <div class="card-body" id="body-left">
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px">
          <div class="skeleton skel-line"></div>
          <div class="skeleton skel-line short"></div>
          <div class="skeleton skel-line shorter"></div>
        </div>
        <div class="metrics-strip">
          <div class="metric"><div class="skeleton skel-metric"></div></div>
          <div class="metric"><div class="skeleton skel-metric"></div></div>
          <div class="metric"><div class="skeleton skel-metric"></div></div>
        </div>
        <div class="psych-tags">
          <div class="skeleton skel-tag"></div>
          <div class="skeleton skel-tag"></div>
          <div class="skeleton skel-tag"></div>
        </div>
        <div class="skeleton skel-btn"></div>
        <div class="loading-indicator">
          <div class="loading-dots"><span></span><span></span><span></span></div>
          AI generating profile...
        </div>
      </div>
    </div>

    <div class="vs-divider">
      <div class="vs-line"></div>
      <div class="vs-badge">VS</div>
      <div class="vs-line-bottom"></div>
    </div>

    <div class="strategy-card" id="card-right" onclick="selectStrategy('right')">
      <div class="card-hero card-hero-right">
        <div class="card-badge badge-right">Strategy B</div>
        <div id="hero-right-content">
          <div class="skel-icon skeleton"></div>
          <div class="skel-title skeleton"></div>
          <div class="skel-sub skeleton"></div>
        </div>
      </div>
      <div class="card-body" id="body-right">
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px">
          <div class="skeleton skel-line"></div>
          <div class="skeleton skel-line short"></div>
          <div class="skeleton skel-line shorter"></div>
        </div>
        <div class="metrics-strip">
          <div class="metric"><div class="skeleton skel-metric"></div></div>
          <div class="metric"><div class="skeleton skel-metric"></div></div>
          <div class="metric"><div class="skeleton skel-metric"></div></div>
        </div>
        <div class="psych-tags">
          <div class="skeleton skel-tag"></div>
          <div class="skeleton skel-tag"></div>
          <div class="skeleton skel-tag"></div>
        </div>
        <div class="skeleton skel-btn"></div>
        <div class="loading-indicator">
          <div class="loading-dots"><span></span><span></span><span></span></div>
          AI generating profile...
        </div>
      </div>
    </div>
  </div>

  <!-- Result panel (hidden until selection + AI done) -->
  <div class="result-panel" id="resultPanel">
    <div class="result-header">
      <div class="result-header-left">
        <div class="result-icon" id="resultIcon">üöÄ</div>
        <div>
          <div class="result-title" id="resultTitle">Loading‚Ä¶</div>
          <div class="result-desc" id="resultDesc">Generating your personalised profile</div>
        </div>
      </div>
      <div class="ai-badge-sm">ü§ñ AI Profile Ready</div>
    </div>
    <div class="result-body">
      <div class="insight-grid" id="insightGrid">
        <div class="insight-card"><div class="skeleton skel-line" style="height:40px;border-radius:6px"></div></div>
        <div class="insight-card"><div class="skeleton skel-line" style="height:40px;border-radius:6px"></div></div>
        <div class="insight-card"><div class="skeleton skel-line" style="height:40px;border-radius:6px"></div></div>
        <div class="insight-card"><div class="skeleton skel-line" style="height:40px;border-radius:6px"></div></div>
      </div>
      <div class="ai-insight-text-result" id="aiResultText">
        <div class="loading-indicator">
          <div class="loading-dots"><span></span><span></span><span></span></div>
          AI personalising your result‚Ä¶
        </div>
      </div>
      <div class="result-footer" id="resultFooter"></div>
    </div>
  </div>

</div>

<!-- XP Toast -->
<div class="xp-toast" id="xpToast">
  <div class="xp-amount" id="xpAmount">+20 XP</div>
  <div class="xp-reason" id="xpReason">Profile set!</div>
</div>

<!-- Progress Overlay for Curriculum Generation -->
<div id="progressOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; display:none; align-items:center; justify-content:center; flex-direction:column;">
  <div style="text-align:center; max-width:400px; padding:40px;">
    <div style="font-size:48px; margin-bottom:20px;">üß†</div>
    <h2 style="color:#fff; margin-bottom:8px; font-family:'IBM Plex Sans',sans-serif;">Building Your Curriculum...</h2>
    <p id="progressText" style="color:#aaa; font-size:14px; margin-bottom:24px;">Generating personalized questions with AI...</p>
    <div style="width:100%; height:8px; background:#1a1a2e; border-radius:4px; overflow:hidden;">
      <div id="curriculumProgressFill" style="width:0%; height:100%; background:linear-gradient(90deg,#ff444f,#ff6b6b); border-radius:4px; transition:width 0.3s ease;"></div>
    </div>
    <p id="progressPercent" style="color:#666; font-size:12px; margin-top:8px;">0%</p>
  </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let chosen = null;
let profileData = { left: null, right: null };
let cardsReady = false;

// ‚îÄ‚îÄ Backend URL ‚îÄ‚îÄ
const BACKEND_URL = "http://localhost:8000";
const PROXY_URL = BACKEND_URL + "/api/claude";

// Get user session ‚Äî check URL param first (passed from extension), then localStorage
function getUserSession() {
  try {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('session');
    if (encoded) {
      const decoded = decodeURIComponent(atob(encoded));
      localStorage.setItem('user_session', decoded);
      window.history.replaceState({}, '', window.location.pathname);
      return JSON.parse(decoded);
    }
    const raw = localStorage.getItem('user_session');
    return raw ? JSON.parse(raw) : null;
  } catch { return null; }
}

async function callClaude(systemPrompt, userMessage) {
  const response = await fetch(PROXY_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: "claude-sonnet-4-20250514",
      max_tokens: 1000,
      system: systemPrompt,
      messages: [{ role: "user", content: userMessage }]
    })
  });

  if (!response.ok) {
    const err = await response.text();
    throw new Error(`Proxy error ${response.status}: ${err}`);
  }

  const data = await response.json();
  const raw = data.content.map(b => b.text || "").join("");
  // Strip markdown code fences if the model wraps its JSON
  return raw.replace(/^```json\s*/i, "").replace(/```\s*$/, "").trim();
}


// ‚îÄ‚îÄ Generate both strategy cards on load ‚îÄ‚îÄ
async function generateStrategyCards() {
  const systemPrompt = `You are a trading education AI for PocketPT, a retail trading app. 
Generate two contrasting trading strategy profiles in valid JSON only ‚Äî no extra text, no markdown fences.
The JSON must match this exact shape:
{
  "strategies": [
    {
      "side": "left",
      "icon": "emoji",
      "title": "Strategy Name",
      "subtitle": "Style descriptor ¬∑ Technique",
      "description": "2 sentences. Second-person, energetic. Include <em> on a key phrase.",
      "traits": [
        { "icon": "emoji", "label": "Trait name", "detail": "one sentence explanation" },
        { "icon": "emoji", "label": "Trait name", "detail": "one sentence explanation" },
        { "icon": "emoji", "label": "Trait name", "detail": "one sentence explanation" },
        { "icon": "emoji", "label": "Trait name", "detail": "one sentence explanation" }
      ],
      "metrics": {
        "winRate": "40‚Äì50%",
        "rr": "1:3+",
        "speed": "Fast"
      },
      "psychTags": ["tag1", "tag2", "tag3", "tag4"],
      "colorClass": "red",
      "btnLabel": "Choose [Name] ‚Üí"
    },
    {
      "side": "right",
      "icon": "emoji",
      "title": "Strategy Name",
      "subtitle": "Style descriptor ¬∑ Technique",
      "description": "2 sentences. Second-person, calm. Include <em> on a key phrase.",
      "traits": [
        { "icon": "emoji", "label": "Trait name", "detail": "one sentence explanation" },
        { "icon": "emoji", "label": "Trait name", "detail": "one sentence explanation" },
        { "icon": "emoji", "label": "Trait name", "detail": "one sentence explanation" },
        { "icon": "emoji", "label": "Trait name", "detail": "one sentence explanation" }
      ],
      "metrics": {
        "winRate": "60‚Äì70%",
        "rr": "1:1.5",
        "speed": "Slow"
      },
      "psychTags": ["tag1", "tag2", "tag3", "tag4"],
      "colorClass": "teal",
      "btnLabel": "Choose [Name] ‚Üí"
    }
  ]
}
Strategy A (left/red) should be a high-energy, trend-following style (momentum, breakouts, fast decisions).
Strategy B (right/teal) should be a patient, analytical style (mean reversion, counter-trend, careful entries).
Keep descriptions punchy and authentic to retail traders. Vary the exact framing each time.`;

  try {
    const raw = await callClaude(systemPrompt, "Generate two trading strategy profiles for PocketPT onboarding.");
    const parsed = JSON.parse(raw);
    parsed.strategies.forEach(s => { profileData[s.side] = s; });
    renderCards();
    cardsReady = true;
  } catch (err) {
    showCardError('left', err);
    showCardError('right', err);
  }
}

function showCardError(side, err) {
  document.getElementById('body-' + side).innerHTML = `
    <div class="error-msg">
      <strong>Failed to load profile.</strong> ${err.message}<br>
      <button class="btn-ghost" style="margin-top:10px;font-size:12px" onclick="generateStrategyCards()">‚Üª Retry</button>
    </div>`;
}

function renderCards() {
  ['left', 'right'].forEach(side => {
    const p = profileData[side];
    if (!p) return;
    const colorClass = p.colorClass || (side === 'left' ? 'red' : 'teal');

    // Hero
    document.getElementById('hero-' + side + '-content').innerHTML = `
      <div class="card-icon">${p.icon}</div>
      <div class="card-title">${p.title}</div>
      <div class="card-subtitle">${p.subtitle}</div>`;

    // Body
    document.getElementById('body-' + side).innerHTML = `
      <p class="card-desc">${p.description}</p>
      <div class="trait-list">
        ${p.traits.map(t => `
          <div class="trait-row">
            <div class="trait-icon">${t.icon}</div>
            <div class="trait-text"><strong>${t.label}</strong> ‚Äî ${t.detail}</div>
          </div>`).join('')}
      </div>
      <div class="metrics-strip">
        <div class="metric">
          <div class="metric-val ${colorClass}">${p.metrics.winRate}</div>
          <div class="metric-label">Win Rate</div>
        </div>
        <div class="metric">
          <div class="metric-val ${colorClass}">${p.metrics.rr}</div>
          <div class="metric-label">Avg R:R</div>
        </div>
        <div class="metric">
          <div class="metric-val ${colorClass}">${p.metrics.speed}</div>
          <div class="metric-label">Decision Speed</div>
        </div>
      </div>
      <div class="psych-tags">
        ${p.psychTags.map(tag => `<div class="psych-tag">${tag}</div>`).join('')}
      </div>
      <button class="select-btn select-btn-${side}" id="btn-${side}">${p.btnLabel}</button>`;
  });
}

// ‚îÄ‚îÄ Strategy selection ‚îÄ‚îÄ
function selectStrategy(side) {
  if (!cardsReady) return; // don't allow clicks while loading
  if (chosen === side) return;
  chosen = side;
  const other = side === 'left' ? 'right' : 'left';

  document.getElementById('card-' + side).className = 'strategy-card selected-' + side;
  document.getElementById('card-' + other).className = 'strategy-card unselected';

  const btnSide = document.getElementById('btn-' + side);
  const btnOther = document.getElementById('btn-' + other);
  if (btnSide) { btnSide.textContent = '‚úì Selected'; btnSide.classList.add('chosen'); }
  if (btnOther) {
    const otherProfile = profileData[other];
    btnOther.textContent = otherProfile ? otherProfile.btnLabel : (other === 'left' ? 'Choose Momentum ‚Üí' : 'Choose Precision ‚Üí');
    btnOther.classList.remove('chosen');
  }

  showResultPanel(side);
  addXP(25, 'Trading style chosen!');
}

// ‚îÄ‚îÄ AI-generated result panel ‚îÄ‚îÄ
async function showResultPanel(side) {
  const p = profileData[side];
  const panel = document.getElementById('resultPanel');

  // Show panel immediately with skeleton/loading state
  document.getElementById('resultIcon').textContent = p.icon;
  document.getElementById('resultTitle').textContent = p.title + ' selected';
  document.getElementById('resultDesc').textContent = 'Generating your personalised profile‚Ä¶';
  document.getElementById('insightGrid').innerHTML = `
    <div class="insight-card"><div class="skeleton skel-line" style="height:40px;border-radius:6px"></div></div>
    <div class="insight-card"><div class="skeleton skel-line" style="height:40px;border-radius:6px"></div></div>
    <div class="insight-card"><div class="skeleton skel-line" style="height:40px;border-radius:6px"></div></div>
    <div class="insight-card"><div class="skeleton skel-line" style="height:40px;border-radius:6px"></div></div>`;
  document.getElementById('aiResultText').innerHTML = `
    <div class="loading-indicator">
      <div class="loading-dots"><span></span><span></span><span></span></div>
      AI personalising your insight‚Ä¶
    </div>`;
  document.getElementById('aiResultText').className = 'ai-insight-text-result' + (side === 'right' ? ' teal' : '');
  document.getElementById('resultFooter').innerHTML = '';
  panel.classList.add('visible');
  setTimeout(() => panel.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);

  // Ask Claude for personalised result panel content
  const systemPrompt = `You are a trading psychology AI tutor for PocketPT. Generate a personalised result panel in valid JSON only ‚Äî no markdown, no extra text.
JSON shape:
{
  "desc": "short subtitle, 1 line, lowercase",
  "insights": [
    { "label": "First Lesson", "val": "topic name" },
    { "label": "Watch out for", "val": "common pitfall" },
    { "label": "Key Indicator", "val": "indicator name" },
    { "label": "Best Instrument", "val": "market / pair" }
  ],
  "aiText": "2‚Äì3 sentences. Use <strong> for key warnings, <em> for emphasis. Address the user directly. Identify their #1 early challenge and what their first lessons will fix."
}`;

  try {
    const raw = await callClaude(
      systemPrompt,
      `The user chose the "${p.title}" style (${p.subtitle}). Their traits: ${p.traits.map(t => t.label).join(', ')}. Their psych profile: ${p.psychTags.join(', ')}. Generate a personalised result panel for them.`
    );
    const result = JSON.parse(raw);

    document.getElementById('resultDesc').textContent = result.desc;
    document.getElementById('insightGrid').innerHTML = result.insights.map(i => `
      <div class="insight-card">
        <div class="insight-label">${i.label}</div>
        <div class="insight-val">${i.val}</div>
      </div>`).join('');
    document.getElementById('aiResultText').innerHTML = result.aiText;
    document.getElementById('resultFooter').innerHTML = `
      <button class="btn-primary${side === 'right' ? ' teal' : ''}" onclick="startCurriculum()">Start My Curriculum ‚Üí</button>
      <button class="btn-ghost" onclick="resetChoice()">‚Üê Change my mind</button>`;

  } catch (err) {
    document.getElementById('aiResultText').innerHTML = `
      <div class="error-msg">
        <strong>Couldn't generate insight.</strong> ${err.message}<br>
        <button class="btn-ghost" style="margin-top:10px;font-size:12px" onclick="showResultPanel('${side}')">‚Üª Retry</button>
      </div>`;
    document.getElementById('resultFooter').innerHTML = `
      <button class="btn-primary${side === 'right' ? ' teal' : ''}" onclick="startCurriculum()">Start My Curriculum ‚Üí</button>
      <button class="btn-ghost" onclick="resetChoice()">‚Üê Change my mind</button>`;
  }
}

function resetChoice() {
  chosen = null;
  ['left', 'right'].forEach(side => {
    document.getElementById('card-' + side).className = 'strategy-card';
    const btn = document.getElementById('btn-' + side);
    if (btn) { btn.classList.remove('chosen'); btn.textContent = profileData[side] ? profileData[side].btnLabel : '‚Äî'; }
  });
  document.getElementById('resultPanel').classList.remove('visible');
}

// ‚îÄ‚îÄ XP ‚îÄ‚îÄ
function addXP(amount, reason) {
  document.getElementById('xpAmount').textContent = '+' + amount + ' XP';
  document.getElementById('xpReason').textContent = reason;
  const t = document.getElementById('xpToast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ‚îÄ‚îÄ Save trader type & generate curriculum ‚îÄ‚îÄ
async function startCurriculum() {
  if (!chosen) return;

  const traderType = chosen === 'left' ? 'momentum' : 'precision';
  const session = getUserSession();

  if (!session || !session.id) {
    localStorage.setItem('tradept_trader_type', traderType);
    alert('No session found. Please log in first.');
    return;
  }

  // 1. Save trader type
  let updatedUser = session;
  try {
    const resp = await fetch(`${BACKEND_URL}/users/${session.id}/trader-type`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trader_type: traderType })
    });
    if (resp.ok) {
      updatedUser = await resp.json();
      localStorage.setItem('user_session', JSON.stringify(updatedUser));
    }
  } catch (err) {
    console.error('Failed to save trader type:', err);
  }

  // 2. Show progress overlay
  const overlay = document.getElementById('progressOverlay');
  overlay.style.display = 'flex';
  const fill = document.getElementById('curriculumProgressFill');
  const pct = document.getElementById('progressPercent');
  const txt = document.getElementById('progressText');

  // Animate fake progress (0 ‚Üí 80% over 4s while API runs)
  let progress = 0;
  const progressInterval = setInterval(() => {
    if (progress < 80) {
      progress += 2;
      fill.style.width = progress + '%';
      pct.textContent = progress + '%';
    }
    if (progress === 20) txt.textContent = 'Generating AI-powered questions...';
    if (progress === 50) txt.textContent = 'Building personalized modules...';
    if (progress === 70) txt.textContent = 'Almost ready...';
  }, 100);

  // 3. Generate curriculum
  try {
    const genResp = await fetch(`${BACKEND_URL}/education/generate-curriculum`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: session.id })
    });

    clearInterval(progressInterval);

    if (genResp.ok) {
      const result = await genResp.json();
      fill.style.width = '100%';
      pct.textContent = '100%';
      txt.textContent = `Curriculum ready! ${result.generated + result.cached} modules loaded.`;

      // Redirect to dashboard after brief pause
      setTimeout(() => {
        const encoded = btoa(encodeURIComponent(JSON.stringify(updatedUser)));
        window.location.href = `/static/trading_edu.html?session=${encoded}`;
      }, 1200);
    } else {
      throw new Error('Generation failed');
    }
  } catch (err) {
    clearInterval(progressInterval);
    console.error('Curriculum generation failed:', err);
    txt.textContent = 'Generation failed. Redirecting...';
    fill.style.background = '#ff4444';

    // Still redirect to dashboard (quizzes can be generated on-demand)
    setTimeout(() => {
      const encoded = btoa(encodeURIComponent(JSON.stringify(updatedUser)));
      window.location.href = `/static/trading_edu.html?session=${encoded}`;
    }, 1500);
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
generateStrategyCards();
</script>
</body>
</html>